name: Beautiful Jekyll CI
on: [push, pull_request]
jobs:
  build:
    name: Build Jekyll
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Build the site in the jekyll/builder container
        run: |
          export JEKYLL_VERSION=3.8
          docker run \
          -v ${{ github.workspace }}:/srv/jekyll \
          -v ${{ github.workspace }}/_site:/srv/jekyll/_site \
          -e PAGES_REPO_NWO=${{ github.repository }} \
          jekyll/builder:$JEKYLL_VERSION /bin/bash -lc "
            set -e
            cd /srv/jekyll

            # Remove any vendored gems that might include site templates
            rm -rf vendor/bundle || true
            
            # --- FIX 1: Update RubyGems to fix the 3.0.6 bug ---
            gem update --system 3.2.3

            # Install a Bundler version compatible with this environment if needed
            gem install bundler -v 2.4.22 --no-document || gem install bundler --no-document || true

            if [ -f Gemfile ]; then
              bundle install --jobs 4 --retry 3
              # --- FIX 2: Removed --exclude flag (handled by _config.yml now) ---
              bundle exec jekyll build --future -d _site
            else
              gem install jekyll -v 3.8.6 --no-document
              # --- FIX 2: Removed --exclude flag here too ---
              jekyll build --future -d _site
            fi
          "
